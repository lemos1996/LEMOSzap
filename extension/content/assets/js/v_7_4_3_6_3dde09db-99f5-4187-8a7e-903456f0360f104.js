import{ar as I,as as u,m as w}from"./v_7_4_3_6_3dde09db-99f5-4187-8a7e-903456f0360f23.js";import{u as h,a as f}from"./v_7_4_3_6_3dde09db-99f5-4187-8a7e-903456f0360f20.js";import{u as E}from"./v_7_4_3_6_3dde09db-99f5-4187-8a7e-903456f0360f125.js";import"./v_7_4_3_6_3dde09db-99f5-4187-8a7e-903456f0360f.js";import{P as A,I as g,S as P,G as M}from"./v_7_4_3_6_3dde09db-99f5-4187-8a7e-903456f0360f11.js";import{c as z}from"./v_7_4_3_6_3dde09db-99f5-4187-8a7e-903456f0360f8.js";import{u as C}from"./v_7_4_3_6_3dde09db-99f5-4187-8a7e-903456f0360f26.js";import{W as y}from"./v_7_4_3_6_3dde09db-99f5-4187-8a7e-903456f0360f19.js";async function _(a,n=1e4,e=void 0){try{return await Promise.race([a,new Promise(s=>setTimeout(()=>s(e),n))])}catch(s){return console.error("Erro em safeAwait:",s),e}}const $=async a=>{try{const{randomIA:n}=d.getState().config;if(!n)return a;const e=["Refatore a mensagem mantendo a mesma semântica","Entidades imutáveis: preserve nomes, números, datas, prazos, preços, políticas, links e contatos exatamente iguais (não reescreva URLs)","Comprimento: mantenha entre -10% e +10% do tamanho original","Entidades imutáveis: preserve nomes, números, datas, prazos, preços, políticas, links e contatos exatamente iguais","Oferta/CTA: mantenha a mesma oferta; escolha uma CTA apenas da lista fornecida (sem inventar novas)","Variação limitada: sinônimos moderados e pequenas mudanças na ordem das mesmas ideias; conectores e pontuação podem variar","Emojis: Inserir emoji apenas caso necessário e caso tenha pode realizar uma randomização nele desde que mantenha a mesma intenção","Linha: Respeite os espaçamentos de linha, mantendo a estrutura base do texto, como linha quebrada, espaçamentos entre parágrafos, etc.","Gramatica: Valide o texto por completo e corrija gramaticalmente"],s=await y.IA("text",{agente:"Random",question:a,context:e});return s.success?s.response:a}catch(n){return console.error("Error ao adicionar IA",n),a}},l=a=>{try{const n=d?.getState()?.chats[0];a=a.replaceAll("#primeiroNome",n.name.split(" ")[0]),a=a.replaceAll("#nomes",n.name),a=a.replaceAll("#nome",n.name);for(const e in n)e&&e.length>0&&n.hasOwnProperty(e)&&(a=a.replaceAll(`#${e}`,n[e]));return a}catch(n){return console.error("Erro ao adicionar a #tag do envio em massa",n),a}},R=async()=>{const{acao:a}=u.getState();return await Promise.all(a.map(async e=>{const s={...e};if(s.type==="txt"||s.type==="image"||s.type==="video"){const t={...s.propriedades};if(t.mensagem){const o=l(t.mensagem);t.mensagem=await $(o)}s.propriedades=t}if(s.type==="linkPreview"){const t={...s.propriedades};t.description&&(t.description=l(t.description)),t.title&&(t.title=l(t.title)),s.propriedades=t}return s}))},p=(a,n)=>{const{statusEnvio:e,setStatusEnvio:s}=d.getState(),{updateRelatorio:t}=C.getState(),o={id:e.index,nome:n.name,phone:n.id.includes("@g.us")?n.id.replace("@g.us",""):n.id.includes("@c.us")?n.id.replace("@c.us",""):n.id,status:"Erro",hora:Date.now()};a?(o.status="Enviado",s({index:e.index+1,success:e.success+1,percent:Math.round((e.index+1)*100/e.total)})):(o.status="Erro",s({index:e.index+1,erro:e.erro+1,percent:Math.round((e.index+1)*100/e.total)})),d.setState(i=>({chats:i.chats.slice(1)})),t({id:e.id.toString(),send:[o]})};async function D(){const{chats:a,setInfo:n}=d.getState(),{assinatura:e}=E.getState(),{language:s}=h.getState(),t=a[0];try{if(t.id==0){t.name="Whatsapp",p(!1,t);return}if(n(`${s.envMassaRemetente} ${t.name}`),t.imported&&await _(y.Contact("queryExists",A(t.id)),7e3,"undefined")==="undefined"){p(!1,t);return}let o=await I(A(t.id),await R(),e,"useAcaoEnvioEmMassa");p(o,t)}catch(o){console.error("Erro ao tentar realizar o envio",o),p(!1,t)}}async function v(){const{statusEnvio:a,config:n,chats:e,setChats:s,setInfo:t,updateIndexDB:o,setStatusEnvio:i,setActiveAgrupamento:r,setTimePause:m}=d.getState(),{clearAcao:S}=u.getState(),{language:c}=h.getState();if(a.index%parseInt(n.pausa)==0&&a.index>0?(t(`${c.envMassaPausa} ${n.tempoPausa} ${c.segundos}`),await x(parseInt(n.tempoPausa)*1e3)):(t(`${c.envMassaIntervalo} ${n.intervalo} ${c.segundos}`),await x(parseInt(n.intervalo)*1e3)),await D(),o(),e[1]===void 0||a.estado==="Finalized"){r({name:"",color:""}),i({estado:"Finalized"}),s([]),i({estado:"Finalized"}),S(),t(c.envMassaFinalized),o(!0);return}if(!f.getState().session.is_premium&&a.index>4){i({estado:"Paused",pause:!0}),t(c.envMassaPaused),m(!1),g({type:"Info",message:c.envMassaNotLogin,position:"top-right"});return}switch(a.estado){case"Paused":case"Paused-Process":t(c.envMassaPaused),m(!1);break;case"Canceled":o(!0),i({index:0,erro:0,success:0,total:0,percent:0,estado:"Finalized",pause:!1}),t(""),r({name:"",color:""}),S();break;case"Atived":v();break}}function x(a){return new Promise(n=>setTimeout(n,a))}const d=z()((a,n)=>({statusEnvio:{id:0,index:0,erro:0,success:0,total:0,percent:0,estado:"Finalized",pause:!1},setStatusEnvio:e=>a(s=>({statusEnvio:{...s.statusEnvio,...e}})),info:"",setInfo:e=>a({info:e}),chats:[],setChats:e=>a({chats:e}),activeAgrupamento:{name:"",color:""},setActiveAgrupamento:e=>a({activeAgrupamento:e}),send:!1,setSend:e=>a({send:e}),config:{intervalo:"10",pausa:"10",tempoPausa:"60",randomIA:!1},setConfig:(e,s)=>a(t=>({config:{...t.config,[e]:s}})),getVariaveis:()=>{const{chats:e}=n();let s=[];return e.forEach(t=>{Object.keys(t).forEach(o=>{if(!s.includes(o)){if(o==="labels"||o==="imported")return;o==="id"&&(o="numero"),o==="name"&&(o="nome",s.includes("primeiroNome")||s.push("primeiroNome")),s.includes(o)||s.push(o)}})}),s},cancelarEnvio:()=>{const{setStatusEnvio:e,setSend:s,setChats:t,updateIndexDB:o,setActiveAgrupamento:i}=n(),{clearAcao:r}=u.getState(),{setActiveMenu:m}=E.getState();i({name:"",color:""}),t([]),e({estado:"Canceled"}),s(!1),m("Envio Rápido"),r(),o(!0)},timePause:!1,setTimePause:e=>a({timePause:e}),pausePlay:()=>{const{session:e}=f.getState(),{statusEnvio:s,setStatusEnvio:t,timePause:o,setTimePause:i}=n(),{openRendertype:r}=w.getState();if(!e.is_premium){r("user_free");return}o||(s.pause?(t({estado:"Atived",pause:!1}),v()):(t({estado:"Paused",pause:!0}),i(!0)))},initDisparo:()=>{const{updateIndexDB:e,setSend:s,setStatusEnvio:t,chats:o}=n(),{language:i}=h.getState(),{session:r}=f.getState();r.is_premium?g({type:"Info",message:`${i.msg_info_janela}`,position:"top-right"}):(g({type:"Info",message:`${i.msg_info_gratuito}`,position:"top-right"}),d.setState({chats:r.is_premium?o:o.slice(0,5)})),e(),t({id:Date.now(),estado:"Atived",index:0,erro:0,success:0,total:(r.is_premium?o:o.slice(0,5)).length,percent:0}),s(!0),v()},updateIndexDB:(e=!1)=>{const{chats:s,config:t,statusEnvio:o}=n(),{acao:i}=u.getState();e?P("envioEmMassa","useCampanha",{}):P("envioEmMassa","useCampanha",{chats:s,config:t,acao:i,statusEnvio:o})}}));(async()=>{const a=await M("envioEmMassa","useCampanha");a[0]&&a[0]?.chats?.length>0&&(d.setState({chats:a[0].chats,config:a[0].config,statusEnvio:{...a[0].statusEnvio,estado:"Paused",pause:!0},send:!0,info:"Envio das mensagens Pausado"}),u.setState({acao:a[0].acao}),E.getState().setActiveMenu("Enviar Campanha"))})();export{d as u};
